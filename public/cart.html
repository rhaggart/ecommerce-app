<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Shopping Cart</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="modern-style.css">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar is-primary">
        <div class="container">
            <div class="navbar-brand">
                <a class="navbar-item" href="index.html">
                    <span class="icon"><i class="fas fa-arrow-left"></i></span>
                    <span>Continue Shopping</span>
                </a>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <section class="section">
        <div class="container">
            <h1 class="title is-2 mb-5">
                <span class="icon-text">
                    <span class="icon has-text-primary"><i class="fas fa-shopping-cart"></i></span>
                    <span>Shopping Cart</span>
                </span>
            </h1>
            
            <div class="columns">
                <div class="column is-8">
                    <div id="cartItems">
                        <!-- Cart items will be loaded here -->
                    </div>
                </div>
                
                <div class="column is-4">
                    <div class="box">
                        <h3 class="title is-4">Order Summary</h3>
                        <div class="is-divider"></div>
                        <div class="field is-grouped is-grouped-multiline mb-4">
                            <div class="control">
                                <div class="tags has-addons">
                                    <span class="tag is-dark">Total</span>
                                    <span class="tag is-primary is-large">$<span id="cartTotal">0.00</span></span>
                                </div>
                            </div>
                        </div>
                        <button onclick="window.location.href='checkout.html'" id="checkoutBtn" class="button is-primary is-large is-fullwidth">
                            <span class="icon"><i class="fas fa-credit-card"></i></span>
                            <span>Proceed to Checkout</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <script>
        async function loadCart() {
            try {
                const response = await fetch('/api/cart', { credentials: 'include' });
                const cart = await response.json();
                
                console.log('Backend cart:', cart);
                console.log('Cart items:', cart.items);
                
                const container = document.getElementById('cartItems');
                container.innerHTML = '';

                if (!cart.items || cart.items.length === 0) {
                    // Also check localStorage cart
                    const localCart = JSON.parse(localStorage.getItem('cart') || '[]');
                    console.log('localStorage cart:', localCart);
                    console.log('localStorage cart count:', localCart.length);
                    
                    if (localCart.length > 0) {
                        container.innerHTML = `
                            <div class="notification is-warning">
                                <p class="mb-3">Your cart has ${localCart.length} items but they may reference deleted products.</p>
                                <div class="buttons">
                                    <button onclick="clearAllCarts()" class="button is-danger">
                                        <span class="icon"><i class="fas fa-trash"></i></span>
                                        <span>Clear Cart</span>
                                    </button>
                                    <button onclick="syncCart()" class="button is-primary">
                                        <span class="icon"><i class="fas fa-sync"></i></span>
                                        <span>Try to Sync Cart</span>
                                    </button>
                                </div>
                            </div>
                        `;
                    } else {
                        container.innerHTML = `
                            <div class="notification is-light">
                                <p class="has-text-centered">
                                    <span class="icon is-large"><i class="fas fa-shopping-cart fa-3x has-text-grey-light"></i></span>
                                </p>
                                <p class="has-text-centered has-text-grey">Your cart is empty</p>
                                <p class="has-text-centered mt-4">
                                    <a href="index.html" class="button is-primary">
                                        <span class="icon"><i class="fas fa-store"></i></span>
                                        <span>Start Shopping</span>
                                    </a>
                                </p>
                            </div>
                        `;
                    }
                    document.getElementById('checkoutBtn').disabled = true;
                    return;
                }

                let total = 0;

                cart.items.forEach(item => {
                    const product = item.product;
                    if (!product) return;
                    
                    // Calculate price including additional price for print sizes
                    const itemPrice = product.price + (item.additionalPrice || 0);
                    const itemTotal = itemPrice * item.quantity;
                    total += itemTotal;
                    
                    // Get image URL
                    const imageUrl = product.images && product.images[0] ? product.images[0] : 'https://via.placeholder.com/100';

                    const cartItemHTML = `
                        <div class="box mb-3">
                            <article class="media">
                                <figure class="media-left">
                                    <p class="image is-128x128">
                                        <img src="${imageUrl}" alt="${product.name}" style="object-fit: cover; border-radius: 8px;">
                                    </p>
                                </figure>
                                <div class="media-content">
                                    <div class="content">
                                        <p>
                                            <strong class="is-size-5">${product.name}</strong>
                                            ${item.size ? `<br><span class="tag is-light mt-1"><i class="fas fa-ruler mr-1"></i>${item.size}</span>` : ''}
                                            <br>
                                            <span class="has-text-grey">Base Price: $${product.price.toFixed(2)}</span>
                                            ${item.additionalPrice > 0 ? `<br><span class="has-text-grey">Size Upgrade: +$${item.additionalPrice.toFixed(2)}</span>` : ''}
                                            <br>
                                            <span class="has-text-grey">Quantity: ${item.quantity}</span>
                                        </p>
                                    </div>
                                </div>
                                <div class="media-right">
                                    <div class="has-text-right">
                                        <p class="title is-4 has-text-primary mb-3">$${itemTotal.toFixed(2)}</p>
                                        <button onclick="removeFromCart('${product._id}', '${item.size || ''}')" class="button is-danger is-small">
                                            <span class="icon"><i class="fas fa-trash"></i></span>
                                            <span>Remove</span>
                                        </button>
                                    </div>
                                </div>
                            </article>
                        </div>
                    `;
                    container.innerHTML += cartItemHTML;
                });

                document.getElementById('cartTotal').textContent = total.toFixed(2);
            } catch (err) {
                console.error('Error loading cart:', err);
                container.innerHTML = `
                    <div class="notification is-danger">
                        Error loading cart. Please try again.
                    </div>
                `;
            }
        }

        async function removeFromCart(productId, size) {
            try {
                const response = await fetch(`/api/cart/remove/${productId}`, {
                    method: 'DELETE',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ size: size || null })
                });

                if (response.ok) {
                    // Also update localStorage cart
                    const localCart = JSON.parse(localStorage.getItem('cart') || '[]');
                    const updatedCart = localCart.filter(item => 
                        !(item.id === productId && (item.size === size || (!item.size && !size)))
                    );
                    localStorage.setItem('cart', JSON.stringify(updatedCart));
                    
                    // Update cart count in header
                    updateCartCountInHeader(updatedCart);
                    
                    loadCart();
                }
            } catch (err) {
                console.error('Error removing item:', err);
            }
        }
        
        function updateCartCountInHeader(cartItems) {
            const count = cartItems.reduce((sum, item) => sum + item.quantity, 0);
            // Send message to parent window if in iframe, or update directly
            if (window.opener) {
                window.opener.postMessage({ type: 'updateCartCount', count }, '*');
            }
        }

        async function syncCart() {
            const localCart = JSON.parse(localStorage.getItem('cart') || '[]');
            
            for (const item of localCart) {
                try {
                    await fetch('/api/cart/add', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'include',
                        body: JSON.stringify({
                            productId: item.id,
                            quantity: item.quantity
                        })
                    });
                } catch (error) {
                    console.error('Error syncing item:', error);
                }
            }
            
            // Reload cart after sync
            setTimeout(() => {
                loadCart();
            }, 500);
        }
        
        async function clearAllCarts() {
            if (!confirm('Clear all items from cart?')) return;
            
            // Clear localStorage
            localStorage.removeItem('cart');
            
            // Clear backend cart
            try {
                await fetch('/api/cart/clear', {
                    method: 'DELETE',
                    credentials: 'include'
                });
            } catch (error) {
                console.error('Error clearing backend cart:', error);
            }
            
            // Reload page to reset everything
            window.location.reload();
        }

        loadCart();
    </script>
</body>
</html>
