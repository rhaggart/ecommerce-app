<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Online Store</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <header>
        <h1>Our Store</h1>
        <nav>
            <a href="index.html">Shop</a>
            <a href="cart.html">Cart (<span id="cartCount">0</span>)</a>
            <a href="login.html">Admin</a>
        </nav>
    </header>

    <main>
        <div class="filters">
            <input type="text" id="searchInput" placeholder="Search products...">
            <select id="categoryFilter">
                <option value="All">All Categories</option>
            </select>
            <button onclick="filterProducts()">Search</button>
        </div>

        <div id="products" class="product-grid"></div>
    </main>

    <script>
        let allProducts = [];

        async function loadCategories() {
            try {
                const response = await fetch('/api/products/meta/categories');
                const categories = await response.json();
                
                const select = document.getElementById('categoryFilter');
                categories.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat;
                    option.textContent = cat;
                    select.appendChild(option);
                });
            } catch (err) {
                console.error('Error loading categories:', err);
            }
        }

        async function loadProducts() {
            try {
                const response = await fetch('/api/products');
                allProducts = await response.json();
                displayProducts(allProducts);
                updateCartCount();
            } catch (err) {
                console.error('Error loading products:', err);
            }
        }

        function displayProducts(products) {
            const productsContainer = document.getElementById('products');
            productsContainer.innerHTML = '';

            if (products.length === 0) {
                productsContainer.innerHTML = '<p>No products found</p>';
                return;
            }

            products.forEach(product => {
                const productCard = document.createElement('div');
                productCard.className = 'product-card';
                productCard.innerHTML = `
                    <img src="${product.image}" alt="${product.name}">
                    <span class="category-badge">${product.category}</span>
                    <h3>${product.name}</h3>
                    <p>${product.description}</p>
                    <p class="price">$${product.price.toFixed(2)}</p>
                    <p class="stock">In stock: ${product.quantity}</p>
                    <button onclick="addToCart('${product._id}')" ${product.quantity === 0 ? 'disabled' : ''}>
                        ${product.quantity === 0 ? 'Out of Stock' : 'Add to Cart'}
                    </button>
                `;
                productsContainer.appendChild(productCard);
            });
        }

        async function filterProducts() {
            const search = document.getElementById('searchInput').value;
            const category = document.getElementById('categoryFilter').value;
            
            try {
                const params = new URLSearchParams();
                if (search) params.append('search', search);
                if (category) params.append('category', category);
                
                const response = await fetch(`/api/products?${params}`);
                const products = await response.json();
                displayProducts(products);
            } catch (err) {
                console.error('Error filtering products:', err);
            }
        }

        async function addToCart(productId) {
            try {
                const response = await fetch('/api/cart/add', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ productId, quantity: 1 })
                });

                if (response.ok) {
                    alert('Product added to cart!');
                    updateCartCount();
                } else {
                    alert('Error adding to cart');
                }
            } catch (err) {
                console.error('Error:', err);
                alert('Error adding to cart');
            }
        }

        async function updateCartCount() {
            try {
                const response = await fetch('/api/cart', { credentials: 'include' });
                const cart = await response.json();
                const count = cart.items.reduce((sum, item) => sum + item.quantity, 0);
                document.getElementById('cartCount').textContent = count;
            } catch (err) {
                console.error('Error updating cart count:', err);
            }
        }

        loadCategories();
        loadProducts();
    </script>
</body>
</html>