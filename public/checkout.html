<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Checkout</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar is-primary">
        <div class="container">
            <div class="navbar-brand">
                <a class="navbar-item" href="cart.html">
                    <span class="icon"><i class="fas fa-arrow-left"></i></span>
                    <span>Back to Cart</span>
                </a>
            </div>
        </div>
    </nav>

    <!-- Progress Steps -->
    <section class="section pt-4 pb-4">
        <div class="container">
            <nav class="breadcrumb has-succeeds-separator is-centered">
                <ul>
                    <li class="is-active"><a><span class="icon"><i class="fas fa-shopping-cart"></i></span><span>Cart</span></a></li>
                    <li class="is-active"><a><span class="icon"><i class="fas fa-shipping-fast"></i></span><span>Checkout</span></a></li>
                    <li><a><span class="icon"><i class="fas fa-check-circle"></i></span><span>Complete</span></a></li>
                </ul>
            </nav>
        </div>
    </section>

    <!-- Main Content -->
    <section class="section">
        <div class="container">
            <div class="columns">
                <!-- Checkout Form -->
                <div class="column is-7">
                    <div class="box">
                        <h2 class="title is-4 mb-5">Shipping Information</h2>
                        <form id="checkoutForm">
                            <div class="columns">
                                <div class="column">
                                    <div class="field">
                                        <label class="label">First Name</label>
                                        <div class="control has-icons-left">
                                            <input class="input" type="text" id="firstName" required>
                                            <span class="icon is-small is-left"><i class="fas fa-user"></i></span>
                                        </div>
                                    </div>
                                </div>
                                <div class="column">
                                    <div class="field">
                                        <label class="label">Last Name</label>
                                        <div class="control">
                                            <input class="input" type="text" id="lastName" required>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="field">
                                <label class="label">Email</label>
                                <div class="control has-icons-left">
                                    <input class="input" type="email" id="email" required>
                                    <span class="icon is-small is-left"><i class="fas fa-envelope"></i></span>
                                </div>
                            </div>

                            <div class="field">
                                <label class="label">Address</label>
                                <div class="control has-icons-left">
                                    <input class="input" type="text" id="address" required>
                                    <span class="icon is-small is-left"><i class="fas fa-home"></i></span>
                                </div>
                            </div>

                            <div class="columns">
                                <div class="column is-half">
                                    <div class="field">
                                        <label class="label">City</label>
                                        <div class="control">
                                            <input class="input" type="text" id="city" required>
                                        </div>
                                    </div>
                                </div>
                                <div class="column is-one-quarter">
                                    <div class="field">
                                        <label class="label">State</label>
                                        <div class="control">
                                            <input class="input" type="text" id="state" required>
                                        </div>
                                    </div>
                                </div>
                                <div class="column is-one-quarter">
                                    <div class="field">
                                        <label class="label">ZIP</label>
                                        <div class="control">
                                            <input class="input" type="text" id="zip" required>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="field mt-5">
                                <div class="control">
                                    <button type="submit" class="button is-primary is-large is-fullwidth">
                                        <span class="icon"><i class="fas fa-lock"></i></span>
                                        <span>Place Order</span>
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Order Summary -->
                <div class="column is-5">
                    <div class="box">
                        <h3 class="title is-5 mb-4">Order Summary</h3>
                        <div id="orderItems">
                            <!-- Order items will be loaded here -->
                        </div>
                        <hr>
                        <div class="field is-grouped is-grouped-multiline is-justify-content-space-between">
                            <div class="control">
                                <span class="has-text-weight-bold is-size-5">Total:</span>
                            </div>
                            <div class="control">
                                <span class="has-text-primary has-text-weight-bold is-size-4">$<span id="orderTotal">0.00</span></span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="notification is-info is-light">
                        <p class="is-size-7">
                            <span class="icon"><i class="fas fa-shield-alt"></i></span>
                            Your payment information is secure
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <script src="https://js.stripe.com/v3/"></script>
    <script>
        async function loadOrderSummary() {
            try {
                const response = await fetch('/api/cart', { credentials: 'include' });
                const cart = await response.json();
                
                const container = document.getElementById('orderItems');
                
                if (!cart.items || cart.items.length === 0) {
                    window.location.href = 'cart.html';
                    return;
                }

                let total = 0;
                
                container.innerHTML = cart.items.map(item => {
                    const product = item.product;
                    const itemPrice = product.price + (item.additionalPrice || 0);
                    const itemTotal = itemPrice * item.quantity;
                    total += itemTotal;
                    
                    return `
                        <div class="mb-3 pb-3" style="border-bottom: 1px solid #eee;">
                            <div class="is-flex is-justify-content-space-between">
                                <div>
                                    <p class="has-text-weight-semibold">${product.name}</p>
                                    ${item.size ? `<p class="is-size-7 has-text-grey">Size: ${item.size}</p>` : ''}
                                    <p class="is-size-7 has-text-grey">Qty: ${item.quantity}</p>
                                </div>
                                <div class="has-text-right">
                                    <p class="has-text-weight-semibold">$${itemTotal.toFixed(2)}</p>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');

                document.getElementById('orderTotal').textContent = total.toFixed(2);
            } catch (err) {
                console.error('Error loading order summary:', err);
            }
        }

        const form = document.getElementById('checkoutForm');
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const orderData = {
                customer: {
                    firstName: document.getElementById('firstName').value,
                    lastName: document.getElementById('lastName').value,
                    email: document.getElementById('email').value,
                    address: document.getElementById('address').value,
                    city: document.getElementById('city').value,
                    state: document.getElementById('state').value,
                    zip: document.getElementById('zip').value
                }
            };

            try {
                const response = await fetch('/api/orders/checkout', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(orderData)
                });

                const data = await response.json();

                if (response.ok) {
                    // Clear cart
                    localStorage.removeItem('cart');
                    
                    // Show success and redirect
                    alert('Order placed successfully! Order ID: ' + data.order._id);
                    window.location.href = 'orders.html';
                } else {
                    alert('Error: ' + (data.message || 'Failed to place order'));
                }
            } catch (err) {
                console.error('Error:', err);
                alert('Error placing order. Please try again.');
            }
        });

        loadOrderSummary();
    </script>
</body>
</html>

</html>